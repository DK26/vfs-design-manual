<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Security Considerations - AnyFS Ecosystem Manual</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Documentation for AnyFS: pluggable virtual filesystem backends + container layer for Rust">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../css/variables-8adf115d.css">
        <link rel="stylesheet" href="../css/general-2459343d.css">
        <link rel="stylesheet" href="../css/chrome-ae938929.css">
        <link rel="stylesheet" href="../css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="../highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="../ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "rust";
            const default_dark_theme = "coal";
            window.path_to_searchindex_js = "../searchindex-f6aaed69.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc-25c4523f.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">AnyFS Ecosystem Manual</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/DK26/anyfs-design-manual" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>
                        <a href="https://github.com/DK26/anyfs-design-manual/edit/main/src/comparisons/security.md" title="Suggest an edit" aria-label="Suggest an edit" rel="edit">
                            <span class=fa-svg id="git-edit-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M421.7 220.3l-11.3 11.3-22.6 22.6-205 205c-6.6 6.6-14.8 11.5-23.8 14.1L30.8 511c-8.4 2.5-17.5 .2-23.7-6.1S-1.5 489.7 1 481.2L38.7 353.1c2.6-9 7.5-17.2 14.1-23.8l205-205 22.6-22.6 11.3-11.3 33.9 33.9 62.1 62.1 33.9 33.9zM96 353.9l-9.3 9.3c-.9 .9-1.6 2.1-2 3.4l-25.3 86 86-25.3c1.3-.4 2.5-1.1 3.4-2l9.3-9.3H112c-8.8 0-16-7.2-16-16V353.9zM453.3 19.3l39.4 39.4c25 25 25 65.5 0 90.5l-14.5 14.5-22.6 22.6-11.3 11.3-33.9-33.9-62.1-62.1L314.3 67.7l11.3-11.3 22.6-22.6 14.5-14.5c25-25 65.5-25 90.5 0z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="security-considerations"><a class="header" href="#security-considerations">Security Considerations</a></h1>
<p><strong>Security model, threat analysis, and containment guarantees</strong></p>
<hr>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>AnyFS is designed with security as a primary concern. Security policies are enforced via <strong>composable middleware</strong>, not hardcoded in backends or the container wrapper.</p>
<hr>
<h2 id="threat-model"><a class="header" href="#threat-model">Threat Model</a></h2>
<h3 id="in-scope-mitigated-by-middleware"><a class="header" href="#in-scope-mitigated-by-middleware">In Scope (Mitigated by Middleware)</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Threat</th><th>Description</th><th>Middleware</th></tr>
</thead>
<tbody>
<tr><td><strong>Path traversal</strong></td><td>Access files outside allowed paths</td><td><code>PathFilter</code></td></tr>
<tr><td><strong>Symlink attacks</strong></td><td>Use symlinks to bypass controls</td><td>Backend-dependent (see below)</td></tr>
<tr><td><strong>Resource exhaustion</strong></td><td>Fill storage or create excessive files</td><td><code>Quota</code></td></tr>
<tr><td><strong>Runaway processes</strong></td><td>Excessive operations consuming resources</td><td><code>RateLimit</code></td></tr>
<tr><td><strong>Unauthorized writes</strong></td><td>Modifications to read-only data</td><td><code>ReadOnly</code></td></tr>
<tr><td><strong>Sensitive file access</strong></td><td>Access to <code>.env</code>, secrets, etc.</td><td><code>PathFilter</code></td></tr>
</tbody>
</table>
</div>
<h3 id="out-of-scope"><a class="header" href="#out-of-scope">Out of Scope</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Threat</th><th>Reason</th></tr>
</thead>
<tbody>
<tr><td><strong>Side-channel attacks</strong></td><td>Requires OS-level mitigations</td></tr>
<tr><td><strong>Physical access</strong></td><td>Disk encryption is application’s responsibility</td></tr>
<tr><td><strong>SQLite vulnerabilities</strong></td><td>Upstream dependency; update regularly</td></tr>
<tr><td><strong>Network attacks</strong></td><td>AnyFS is local storage, not network-facing</td></tr>
</tbody>
</table>
</div>
<hr>
<h2 id="security-architecture"><a class="header" href="#security-architecture">Security Architecture</a></h2>
<h3 id="1-middleware-based-policy"><a class="header" href="#1-middleware-based-policy">1. Middleware-Based Policy</a></h3>
<p>Security policies are composable middleware layers:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use anyfs::{MemoryBackend, QuotaLayer, PathFilterLayer, RateLimitLayer, TracingLayer};

let secure_backend = MemoryBackend::new()
    .layer(QuotaLayer::builder()              // Limit resources
        .max_total_size(100 * 1024 * 1024)
        .build())
    .layer(PathFilterLayer::builder()         // Sandbox paths
        .allow("/workspace/**")
        .deny("**/.env")
        .deny("**/secrets/**")
        .build())
    .layer(RateLimitLayer::builder()          // Throttle operations
        .max_ops(1000)
        .per_second()
        .build())
    .layer(TracingLayer::new());              // Audit trail
<span class="boring">}</span></code></pre>
<h3 id="2-path-sandboxing-pathfilter"><a class="header" href="#2-path-sandboxing-pathfilter">2. Path Sandboxing (PathFilter)</a></h3>
<p><code>PathFilter</code> middleware restricts path access using glob patterns:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>PathFilterLayer::builder()
    .allow("/workspace/**")    // Allow workspace access
    .deny("**/.env")           // Block .env files
    .deny("**/secrets/**")     // Block secrets directories
    .deny("**/*.key")          // Block key files
    .build()
    .layer(backend)
<span class="boring">}</span></code></pre>
<p><strong>Guarantees:</strong></p>
<ul>
<li>First matching rule wins</li>
<li>No rule = denied (deny by default)</li>
<li><code>read_dir</code> filters denied entries from results</li>
</ul>
<h3 id="3-symlink-capability-via-trait-bounds"><a class="header" href="#3-symlink-capability-via-trait-bounds">3. Symlink Capability via Trait Bounds</a></h3>
<p>Symlink/hard-link capability is determined by <strong>trait bounds</strong>, not middleware:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// MemoryBackend implements FsLink → symlinks work
let fs = FileStorage::new(MemoryBackend::new());
fs.symlink("/target", "/link")?;  // ✅ Works

// Custom backend without FsLink → symlinks won't compile
let fs = FileStorage::new(MySimpleBackend::new());
fs.symlink("/target", "/link")?;  // ❌ Compile error
<span class="boring">}</span></code></pre>
<p><strong>If you don’t want symlinks:</strong> Use a backend that doesn’t implement <code>FsLink</code>.</p>
<p>The <code>Restrictions</code> middleware only controls permission operations:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>RestrictionsLayer::builder()
    .deny_permissions()        // Block set_permissions() calls
    .build()
    .layer(backend)
<span class="boring">}</span></code></pre>
<p><strong>Use cases:</strong></p>
<ul>
<li>Sandboxing untrusted code (block permission changes)</li>
<li>Read-only-ish environments (block permission mutations)</li>
</ul>
<h3 id="4-resource-limits-quota"><a class="header" href="#4-resource-limits-quota">4. Resource Limits (Quota)</a></h3>
<p><code>Quota</code> middleware enforces capacity limits:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>QuotaLayer::builder()
    .max_total_size(100 * 1024 * 1024)  // 100 MB total
    .max_file_size(10 * 1024 * 1024)    // 10 MB per file
    .max_node_count(10_000)             // Max files/dirs
    .max_dir_entries(1_000)             // Max per directory
    .max_path_depth(64)                 // Max nesting
    .build()
    .layer(backend)
<span class="boring">}</span></code></pre>
<p><strong>Guarantees:</strong></p>
<ul>
<li>Writes rejected when limits exceeded</li>
<li>Streaming writes tracked via <code>CountingWriter</code></li>
</ul>
<h3 id="5-rate-limiting-ratelimit"><a class="header" href="#5-rate-limiting-ratelimit">5. Rate Limiting (RateLimit)</a></h3>
<p><code>RateLimit</code> middleware throttles operations:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>RateLimitLayer::builder()
    .max_ops(1000)
    .per_second()
    .build()
    .layer(backend)
<span class="boring">}</span></code></pre>
<p><strong>Guarantees:</strong></p>
<ul>
<li>Operations rejected when limit exceeded</li>
<li>Protects against runaway processes</li>
</ul>
<h3 id="6-backend-level-containment"><a class="header" href="#6-backend-level-containment">6. Backend-Level Containment</a></h3>
<p>Different backends achieve containment differently:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Backend</th><th>Containment Mechanism</th></tr>
</thead>
<tbody>
<tr><td><code>MemoryBackend</code></td><td>Isolated in process memory</td></tr>
<tr><td><code>SqliteBackend</code></td><td>Each container is a separate <code>.db</code> file</td></tr>
<tr><td><code>IndexedBackend</code></td><td>SQLite index + isolated blob directory (UUID-named blobs)</td></tr>
<tr><td><code>StdFsBackend</code></td><td><strong>None</strong> - full filesystem access (do NOT use with untrusted input)</td></tr>
<tr><td><code>VRootFsBackend</code></td><td>Uses <code>strict-path::VirtualRoot</code> to contain paths</td></tr>
</tbody>
</table>
</div>
<blockquote>
<p>⚠️ <strong>Warning:</strong> <code>PathFilter</code> middleware on <code>StdFsBackend</code> does NOT provide sandboxing.
The OS still resolves paths (including symlinks) before <code>PathFilter</code> can check them.
For path containment with real filesystems, use <code>VRootFsBackend</code>.</p>
</blockquote>
<h3 id="7-why-virtual-backends-are-inherently-safe"><a class="header" href="#7-why-virtual-backends-are-inherently-safe">7. Why Virtual Backends Are Inherently Safe</a></h3>
<p>For <code>MemoryBackend</code> and <code>SqliteBackend</code>, the underlying storage is isolated from the host filesystem. There is no OS filesystem to exploit - paths operate entirely within the virtual structure.</p>
<p><strong>Path resolution is symlink-aware but contained</strong>: FileStorage resolves paths by walking the <em>virtual</em> directory structure (using <code>metadata()</code> and <code>read_link()</code> on the backend), not the OS filesystem:</p>
<pre><code>Virtual backend symlink example:
  /foo/bar  where bar → /other/place
  /foo/bar/..  resolves to /other (following the symlink target's parent)

This is correct filesystem semantics - but it happens entirely within
the virtual structure. There is no host filesystem to escape to.
</code></pre>
<p>This means:</p>
<ul>
<li><strong>No host filesystem access</strong> - symlinks point to paths within the virtual structure only</li>
<li><strong>No TOCTOU via OS state</strong> - resolution uses the backend’s own data</li>
<li><strong>No runtime toggle</strong> - symlink following is part of backend semantics (virtual backends that implement <code>FsLink</code> are resolved by <code>FileStorage</code>)</li>
</ul>
<p>For <code>VRootFsBackend</code> (real filesystem), <code>strict-path::VirtualRoot</code> provides equivalent guarantees by validating and containing all paths before they reach the OS.</p>
<h3 id="8-symlink-security-virtual-vs-real-backends"><a class="header" href="#8-symlink-security-virtual-vs-real-backends">8. Symlink Security: Virtual vs Real Backends</a></h3>
<p><strong>The security concern with symlinks is <em>following</em> them, not <em>creating</em> them.</strong></p>
<p>Symlinks are just data. Creating <code>/sandbox/link -&gt; /etc/passwd</code> is harmless. The danger is when reading <code>/sandbox/link</code> follows the symlink and accesses <code>/etc/passwd</code>.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Backend Type</th><th>Symlink Creation</th><th>Symlink Following</th></tr>
</thead>
<tbody>
<tr><td><code>MemoryBackend</code></td><td>Supported (<code>FsLink</code>)</td><td><code>FileStorage</code> resolves (non-<code>SelfResolving</code>)</td></tr>
<tr><td><code>SqliteBackend</code></td><td>Supported (<code>FsLink</code>)</td><td><code>FileStorage</code> resolves (non-<code>SelfResolving</code>)</td></tr>
<tr><td><code>VRootFsBackend</code></td><td>Supported (<code>FsLink</code>)</td><td><strong>OS controls</strong> - <code>strict-path</code> prevents escapes</td></tr>
</tbody>
</table>
</div>
<h4 id="virtual-backends-memory-sqlite"><a class="header" href="#virtual-backends-memory-sqlite">Virtual Backends (Memory, SQLite)</a></h4>
<p>Virtual backends that implement <code>FsLink</code> follow symlinks during <code>FileStorage</code> resolution. Symlink capability is determined by trait bounds:</p>
<ul>
<li><code>MemoryBackend: FsLink</code> → supports symlinks</li>
<li><code>SqliteBackend: FsLink</code> → supports symlinks</li>
<li>Custom backend without <code>FsLink</code> → no symlinks (compile-time enforced)</li>
</ul>
<p>If you need symlink-free behavior, use a backend that does not implement <code>FsLink</code>.</p>
<p><strong>This is the actual security feature</strong> - controlling whether symlinks are even possible via trait bounds.</p>
<h4 id="real-filesystem-backend-vrootfsbackend"><a class="header" href="#real-filesystem-backend-vrootfsbackend">Real Filesystem Backend (VRootFsBackend)</a></h4>
<p>VRootFsBackend calls OS functions (<code>std::fs::read()</code>, etc.) which follow symlinks automatically. <strong>We cannot control this</strong> - the OS does the symlink resolution, not us.</p>
<p><code>strict-path::VirtualRoot</code> prevents <strong>escapes</strong>:</p>
<pre><code>User requests: /sandbox/link
link -&gt; ../../../etc/passwd
strict-path: canonicalize(/sandbox/link) = /etc/passwd
strict-path: /etc/passwd is NOT within /sandbox → DENIED
</code></pre>
<p>This is “follow and verify containment” - symlinks are followed by the OS, but escapes are blocked by strict-path.</p>
<p><strong>Limitation:</strong> Symlinks within the jail are followed. We cannot disable this without implementing custom path resolution (TOCTOU risk) or platform-specific hacks.</p>
<h4 id="summary"><a class="header" href="#summary">Summary</a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Concern</th><th>Virtual Backend</th><th>VRootFsBackend</th></tr>
</thead>
<tbody>
<tr><td>Symlink creation</td><td>Supported (<code>FsLink</code>)</td><td>Supported (<code>FsLink</code>)</td></tr>
<tr><td>Symlink following</td><td><code>FileStorage</code> resolves (non-<code>SelfResolving</code>)</td><td>OS controls (strict-path prevents escapes)</td></tr>
<tr><td>Jail escape via symlink</td><td>No host FS to escape</td><td>Prevented by strict-path</td></tr>
</tbody>
</table>
</div>
<hr>
<h2 id="secure-usage-patterns"><a class="header" href="#secure-usage-patterns">Secure Usage Patterns</a></h2>
<h3 id="ai-agent-sandbox"><a class="header" href="#ai-agent-sandbox">AI Agent Sandbox</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use anyfs::{MemoryBackend, QuotaLayer, PathFilterLayer, RateLimitLayer, TracingLayer, FileStorage};

let sandbox = MemoryBackend::new()
    .layer(QuotaLayer::builder()
        .max_total_size(50 * 1024 * 1024)
        .max_file_size(5 * 1024 * 1024)
        .build())
    .layer(PathFilterLayer::builder()
        .allow("/workspace/**")
        .deny("**/.env")
        .deny("**/secrets/**")
        .build())
    .layer(RateLimitLayer::builder()
        .max_ops(1000)
        .per_second()
        .build())
    .layer(TracingLayer::new());

let fs = FileStorage::new(sandbox);
// Agent code can only access /workspace, limited resources, audited
// Note: MemoryBackend implements FsLink, so symlinks work if needed
<span class="boring">}</span></code></pre>
<h3 id="multi-tenant-isolation"><a class="header" href="#multi-tenant-isolation">Multi-Tenant Isolation</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use anyfs::{SqliteBackend, Quota, FileStorage};

fn create_tenant_storage(tenant_id: &amp;str, quota_bytes: u64) -&gt; FileStorage&lt;impl Fs&gt; {
    let db_path = format!("tenants/{}.db", tenant_id);
    let backend = QuotaLayer::builder()
        .max_total_size(quota_bytes)
        .build()
        .layer(SqliteBackend::open(&amp;db_path).unwrap());

    FileStorage::new(backend)
}

// Complete isolation: separate database files
<span class="boring">}</span></code></pre>
<h3 id="read-only-browsing"><a class="header" href="#read-only-browsing">Read-Only Browsing</a></h3>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use anyfs::{SqliteBackend, ReadOnly, FileStorage};

let readonly_fs = FileStorage::new(
    ReadOnly::new(SqliteBackend::open("archive.db")?)
);

// All write operations return FsError::ReadOnly
<span class="boring">}</span></code></pre>
<hr>
<h2 id="security-checklist"><a class="header" href="#security-checklist">Security Checklist</a></h2>
<h3 id="for-application-developers"><a class="header" href="#for-application-developers">For Application Developers</a></h3>
<ul>
<li><input disabled="" type="checkbox"> Use <code>PathFilter</code> to sandbox untrusted code</li>
<li><input disabled="" type="checkbox"> Use <code>Quota</code> to prevent resource exhaustion</li>
<li><input disabled="" type="checkbox"> Use <code>Restrictions</code> when you need to disable risky operations</li>
<li><input disabled="" type="checkbox"> Use <code>RateLimit</code> for untrusted/shared environments</li>
<li><input disabled="" type="checkbox"> Use <code>Tracing</code> for audit trails</li>
<li><input disabled="" type="checkbox"> Use separate backends for separate tenants</li>
<li><input disabled="" type="checkbox"> Keep dependencies updated</li>
</ul>
<h3 id="for-backend-implementers"><a class="header" href="#for-backend-implementers">For Backend Implementers</a></h3>
<ul>
<li><input disabled="" type="checkbox"> Ensure paths cannot escape intended scope</li>
<li><input disabled="" type="checkbox"> For filesystem backends: use <code>strict-path</code> for containment</li>
<li><input disabled="" type="checkbox"> Handle concurrent access safely</li>
<li><input disabled="" type="checkbox"> Don’t leak internal paths in errors</li>
</ul>
<h3 id="for-middleware-implementers"><a class="header" href="#for-middleware-implementers">For Middleware Implementers</a></h3>
<ul>
<li><input disabled="" type="checkbox"> Handle streaming I/O appropriately (wrap or block)</li>
<li><input disabled="" type="checkbox"> Document which operations are intercepted</li>
<li><input disabled="" type="checkbox"> Fail closed (deny on error)</li>
</ul>
<hr>
<h2 id="encryption-and-integrity-protection"><a class="header" href="#encryption-and-integrity-protection">Encryption and Integrity Protection</a></h2>
<p>AnyFS’s design enables encryption at multiple levels. Understanding the difference between <strong>container-level</strong> and <strong>file-level</strong> protection is crucial for choosing the right approach.</p>
<h3 id="container-level-vs-file-level-protection"><a class="header" href="#container-level-vs-file-level-protection">Container-Level vs File-Level Protection</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Level</th><th>What’s Protected</th><th>Integrity</th><th>Implementation</th></tr>
</thead>
<tbody>
<tr><td><strong>Container-level</strong></td><td>Entire storage medium (<code>.db</code> file, serialized state)</td><td>Full structure protected</td><td>Encrypted backend</td></tr>
<tr><td><strong>File-level</strong></td><td>Individual file contents</td><td>File contents only</td><td>Encryption middleware</td></tr>
</tbody>
</table>
</div>
<p><strong>Key insight:</strong> File-level encryption alone is NOT sufficient. If an attacker can modify the container structure (directory tree, metadata, file names), they can sabotage integrity even without decrypting file contents.</p>
<h3 id="threat-analysis"><a class="header" href="#threat-analysis">Threat Analysis</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Threat</th><th>File-Level Encryption</th><th>Container-Level Encryption</th></tr>
</thead>
<tbody>
<tr><td>Read file contents</td><td>Protected</td><td>Protected</td></tr>
<tr><td>Modify file contents</td><td>Detected (with AEAD)</td><td>Detected</td></tr>
<tr><td>Delete files</td><td><strong>NOT protected</strong></td><td>Protected</td></tr>
<tr><td>Rename/move files</td><td><strong>NOT protected</strong></td><td>Protected</td></tr>
<tr><td>Corrupt directory structure</td><td><strong>NOT protected</strong></td><td>Protected</td></tr>
<tr><td>Replay old file versions</td><td><strong>NOT protected</strong></td><td>Protected (with versioning)</td></tr>
<tr><td>Metadata exposure (filenames, sizes)</td><td><strong>NOT protected</strong></td><td>Protected</td></tr>
</tbody>
</table>
</div>
<p><strong>Recommendation:</strong> For sensitive data, prefer container-level encryption. Use file-level encryption when you need selective access (some files encrypted, others not).</p>
<h3 id="container-level-encryption"><a class="header" href="#container-level-encryption">Container-Level Encryption</a></h3>
<h4 id="option-1-sqlcipher-backend"><a class="header" href="#option-1-sqlcipher-backend">Option 1: SQLCipher Backend</a></h4>
<p><a href="https://www.zetetic.net/sqlcipher/">SQLCipher</a> provides transparent AES-256 encryption for SQLite:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// SQLite backend with full database encryption via SQLCipher.
pub struct SqliteCipherBackend {
    conn: rusqlite::Connection,  // Built with sqlcipher feature
}

impl SqliteCipherBackend {
    pub fn open(path: &amp;str, password: &amp;str) -&gt; Result&lt;Self, FsError&gt; {
        let conn = Connection::open(path)?;
        // SQLCipher: derive key from password, encrypt everything
        conn.pragma_update(None, "key", password)?;
        Ok(Self { conn })
    }

    pub fn open_with_key(path: &amp;str, key: &amp;[u8; 32]) -&gt; Result&lt;Self, FsError&gt; {
        let conn = Connection::open(path)?;
        // Use raw key instead of password
        conn.pragma_update(None, "key", &amp;format!("x'{}'", hex::encode(key)))?;
        Ok(Self { conn })
    }
}

impl Fs for SqliteCipherBackend { /* same as SqliteBackend */ }
<span class="boring">}</span></code></pre>
<p><strong>What’s protected:</strong></p>
<ul>
<li>All file contents</li>
<li>All metadata (names, sizes, timestamps, permissions)</li>
<li>Directory structure</li>
<li>Inode mappings</li>
<li>Everything in the <code>.db</code> file</li>
</ul>
<p><strong>Usage:</strong></p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let backend = SqliteCipherBackend::open("secure.db", "correct-horse-battery-staple")?;
let fs = FileStorage::new(backend);

// If someone gets secure.db without the password, they see random bytes
<span class="boring">}</span></code></pre>
<h4 id="option-2-encrypted-serialization-memorybackend"><a class="header" href="#option-2-encrypted-serialization-memorybackend">Option 2: Encrypted Serialization (MemoryBackend)</a></h4>
<p>For in-memory backends that need persistence:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl MemoryBackend {
    /// Serialize entire state to encrypted blob.
    pub fn serialize_encrypted(&amp;self, key: &amp;[u8; 32]) -&gt; Result&lt;Vec&lt;u8&gt;, FsError&gt; {
        let plaintext = bincode::serialize(&amp;self.state)?;
        let nonce = generate_nonce();
        let ciphertext = aes_gcm_encrypt(key, &amp;nonce, &amp;plaintext)?;
        Ok([nonce.as_slice(), &amp;ciphertext].concat())
    }

    /// Deserialize from encrypted blob.
    pub fn deserialize_encrypted(data: &amp;[u8], key: &amp;[u8; 32]) -&gt; Result&lt;Self, FsError&gt; {
        let (nonce, ciphertext) = data.split_at(12);
        let plaintext = aes_gcm_decrypt(key, nonce, ciphertext)?;
        let state = bincode::deserialize(&amp;plaintext)?;
        Ok(Self { state })
    }
}
<span class="boring">}</span></code></pre>
<p><strong>Use case:</strong> Periodically save encrypted snapshots, load on startup.</p>
<h3 id="file-level-encryption-middleware"><a class="header" href="#file-level-encryption-middleware">File-Level Encryption (Middleware)</a></h3>
<p>When you need selective encryption or per-file keys:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Middleware that encrypts file contents on write, decrypts on read.
/// Does NOT protect metadata, filenames, or directory structure.
pub struct FileEncryption&lt;B&gt; {
    inner: B,
    key: Secret&lt;[u8; 32]&gt;,
}

impl&lt;B: Fs&gt; FsWrite for FileEncryption&lt;B&gt; {
    fn write(&amp;self, path: &amp;Path, data: &amp;[u8]) -&gt; Result&lt;(), FsError&gt; {
        // Encrypt content with authenticated encryption (AES-GCM)
        let nonce = generate_nonce();
        let ciphertext = aes_gcm_encrypt(&amp;self.key, &amp;nonce, data)?;
        let encrypted = [nonce.as_slice(), &amp;ciphertext].concat();
        self.inner.write(path, &amp;encrypted)
    }
}

impl&lt;B: Fs&gt; FsRead for FileEncryption&lt;B&gt; {
    fn read(&amp;self, path: &amp;Path) -&gt; Result&lt;Vec&lt;u8&gt;, FsError&gt; {
        let encrypted = self.inner.read(path)?;
        let (nonce, ciphertext) = encrypted.split_at(12);
        aes_gcm_decrypt(&amp;self.key, nonce, ciphertext)
            .map_err(|_| FsError::IntegrityError { path: path.as_ref().to_path_buf() })
    }
}
<span class="boring">}</span></code></pre>
<p><strong>Limitations:</strong></p>
<ul>
<li>Filenames visible</li>
<li>Directory structure visible</li>
<li>File sizes visible (roughly - ciphertext slightly larger)</li>
<li>Metadata unprotected</li>
</ul>
<p><strong>When to use:</strong></p>
<ul>
<li>Some files need encryption, others don’t</li>
<li>Different files need different keys</li>
<li>Interop with systems that expect plaintext structure</li>
</ul>
<h3 id="integrity-without-encryption"><a class="header" href="#integrity-without-encryption">Integrity Without Encryption</a></h3>
<p>Sometimes you need tamper detection without hiding contents:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Middleware that adds HMAC to each file for integrity verification.
pub struct IntegrityVerified&lt;B&gt; {
    inner: B,
    key: Secret&lt;[u8; 32]&gt;,
}

impl&lt;B: Fs&gt; FsWrite for IntegrityVerified&lt;B&gt; {
    fn write(&amp;self, path: &amp;Path, data: &amp;[u8]) -&gt; Result&lt;(), FsError&gt; {
        let mac = hmac_sha256(&amp;self.key, data);
        let protected = [data, mac.as_slice()].concat();
        self.inner.write(path, &amp;protected)
    }
}

impl&lt;B: Fs&gt; FsRead for IntegrityVerified&lt;B&gt; {
    fn read(&amp;self, path: &amp;Path) -&gt; Result&lt;Vec&lt;u8&gt;, FsError&gt; {
        let protected = self.inner.read(path)?;
        let (data, mac) = protected.split_at(protected.len() - 32);
        if !hmac_verify(&amp;self.key, data, mac) {
            return Err(FsError::IntegrityError { path: path.as_ref().to_path_buf() });
        }
        Ok(data.to_vec())
    }
}
<span class="boring">}</span></code></pre>
<h3 id="ram-encryption-and-secure-memory"><a class="header" href="#ram-encryption-and-secure-memory">RAM Encryption and Secure Memory</a></h3>
<p>For high-security scenarios where memory dumps are a threat:</p>
<h4 id="threat-levels"><a class="header" href="#threat-levels">Threat Levels</a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Threat</th><th>Mitigation</th><th>Library-Level?</th></tr>
</thead>
<tbody>
<tr><td>Memory inspection after process exit</td><td><code>zeroize</code> on drop</td><td>Yes</td></tr>
<tr><td>Core dumps</td><td>Disable via <code>setrlimit</code></td><td>Yes (process config)</td></tr>
<tr><td>Swap file exposure</td><td><code>mlock()</code> to pin pages</td><td>Yes (OS permitting)</td></tr>
<tr><td>Live memory scanning (same user)</td><td>OS process isolation</td><td>No</td></tr>
<tr><td>Cold boot attack</td><td>Hardware RAM encryption</td><td>No (Intel TME/AMD SME)</td></tr>
<tr><td>Hypervisor/DMA attack</td><td>SGX/SEV enclaves</td><td>No (hardware)</td></tr>
</tbody>
</table>
</div>
<h4 id="encrypted-memory-backend-illustrative-pattern"><a class="header" href="#encrypted-memory-backend-illustrative-pattern">Encrypted Memory Backend (Illustrative Pattern)</a></h4>
<blockquote>
<p><strong>Note:</strong> <code>EncryptedMemoryBackend</code> is an illustrative pattern for users who need encrypted RAM storage. It is not a built-in backend. Users can implement this pattern using the guidance below.</p>
</blockquote>
<p>Keep data encrypted even in RAM - decrypt only during active use:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use zeroize::{Zeroize, ZeroizeOnDrop};
use secrecy::Secret;

/// Memory backend that stores all data encrypted in RAM.
/// Plaintext exists only briefly during read operations.
pub struct EncryptedMemoryBackend {
    /// All nodes stored as encrypted blobs
    nodes: HashMap&lt;PathBuf, EncryptedNode&gt;,
    /// Encryption key - auto-zeroized on drop
    key: Secret&lt;[u8; 32]&gt;,
}

struct EncryptedNode {
    /// Encrypted file content (nonce || ciphertext)
    encrypted_data: Vec&lt;u8&gt;,
    /// Metadata can be encrypted too, or stored in the encrypted blob
    metadata: EncryptedMetadata,
}

impl FsRead for EncryptedMemoryBackend {
    fn read(&amp;self, path: &amp;Path) -&gt; Result&lt;Vec&lt;u8&gt;, FsError&gt; {
        let node = self.nodes.get(path.as_ref())
            .ok_or_else(|| FsError::NotFound { path: path.as_ref().to_path_buf() })?;

        // Decrypt - plaintext briefly in RAM
        let plaintext = self.decrypt(&amp;node.encrypted_data)?;

        // Return owned Vec - caller responsible for zeroizing if sensitive
        Ok(plaintext)
    }
}

impl FsWrite for EncryptedMemoryBackend {
    fn write(&amp;self, path: &amp;Path, data: &amp;[u8]) -&gt; Result&lt;(), FsError&gt; {
        // Encrypt immediately - plaintext never stored
        let encrypted = self.encrypt(data)?;

        self.nodes.insert(path.as_ref().to_path_buf(), EncryptedNode {
            encrypted_data: encrypted,
            metadata: self.encrypt_metadata(...)?,
        });
        Ok(())
    }
}

impl Drop for EncryptedMemoryBackend {
    fn drop(&amp;mut self) {
        // Zeroize all encrypted data (defense in depth)
        for node in self.nodes.values_mut() {
            node.encrypted_data.zeroize();
        }
        // Key is auto-zeroized via Secret&lt;&gt;
    }
}
<span class="boring">}</span></code></pre>
<h4 id="serialization-of-encrypted-ram"><a class="header" href="#serialization-of-encrypted-ram">Serialization of Encrypted RAM</a></h4>
<p>When persisting an encrypted memory backend:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl EncryptedMemoryBackend {
    /// Serialize to disk - data stays encrypted throughout.
    /// RAM encrypted → Serialized encrypted → Disk encrypted
    pub fn save_to_file(&amp;self, path: &amp;Path) -&gt; Result&lt;(), FsError&gt; {
        // Data is already encrypted in self.nodes
        // Serialize the encrypted blobs directly - no decryption needed
        let serialized = bincode::serialize(&amp;self.nodes)?;

        // Optionally add another encryption layer with different key
        // (defense in depth: compromise of runtime key doesn't expose persisted data)
        std::fs::write(path, &amp;serialized)?;
        Ok(())
    }

    /// Load from disk - data stays encrypted throughout.
    /// Disk encrypted → Deserialized encrypted → RAM encrypted
    pub fn load_from_file(path: &amp;Path, key: Secret&lt;[u8; 32]&gt;) -&gt; Result&lt;Self, FsError&gt; {
        let serialized = std::fs::read(path)?;
        let nodes = bincode::deserialize(&amp;serialized)?;

        Ok(Self { nodes, key })
    }
}
<span class="boring">}</span></code></pre>
<p><strong>Key property:</strong> Plaintext NEVER exists during save/load. Data flows:</p>
<pre><code>Write: plaintext → encrypt → RAM (encrypted) → serialize → disk (encrypted)
Read:  disk (encrypted) → deserialize → RAM (encrypted) → decrypt → plaintext
</code></pre>
<h4 id="secure-allocator-considerations"><a class="header" href="#secure-allocator-considerations">Secure Allocator Considerations</a></h4>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// In Cargo.toml - mimalloc secure mode zeros on free
mimalloc = { version = "0.1", features = ["secure"] }

// Note: This prevents USE-AFTER-FREE info leaks, but does NOT:
// - Encrypt RAM contents
// - Prevent live memory scanning
// - Protect against cold boot attacks
<span class="boring">}</span></code></pre>
<p>For true defense against memory scanning, combine:</p>
<ol>
<li><code>EncryptedMemoryBackend</code> (data encrypted at rest in RAM)</li>
<li><code>zeroize</code> (immediate cleanup of temporary plaintext)</li>
<li><code>mlock()</code> (prevent swapping sensitive pages)</li>
<li>Minimize plaintext lifetime (decrypt → use → zeroize immediately)</li>
</ol>
<h3 id="encryption-summary"><a class="header" href="#encryption-summary">Encryption Summary</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Approach</th><th>Protects Contents</th><th>Protects Structure</th><th>RAM Security</th><th>Persistence</th></tr>
</thead>
<tbody>
<tr><td><code>SqliteCipherBackend</code></td><td>Yes</td><td>Yes</td><td>No (SQLite uses plaintext RAM)</td><td>Encrypted <code>.db</code> file</td></tr>
<tr><td><code>FileEncryption&lt;B&gt;</code> middleware</td><td>Yes</td><td>No</td><td>Depends on B</td><td>Depends on B</td></tr>
<tr><td><code>EncryptedMemoryBackend</code> (illustrative)</td><td>Yes</td><td>Yes</td><td>Yes (encrypted in RAM)</td><td>Via <code>save_to_file()</code></td></tr>
<tr><td><code>IntegrityVerified&lt;B&gt;</code> middleware</td><td>No</td><td>No (files only)</td><td>No</td><td>Depends on B</td></tr>
</tbody>
</table>
</div>
<h3 id="recommended-configurations"><a class="header" href="#recommended-configurations">Recommended Configurations</a></h3>
<h4 id="sensitive-data-storage"><a class="header" href="#sensitive-data-storage">Sensitive Data Storage</a></h4>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Full protection: encrypted container + secure memory practices
let backend = SqliteCipherBackend::open("secure.db", password)?;
let fs = FileStorage::new(backend);
<span class="boring">}</span></code></pre>
<h4 id="high-security-ram-processing-illustrative"><a class="header" href="#high-security-ram-processing-illustrative">High-Security RAM Processing (Illustrative)</a></h4>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Data never plaintext at rest (RAM or disk)
// Note: EncryptedMemoryBackend is user-implemented (see pattern above)
let backend = EncryptedMemoryBackend::new(derive_key(password));
// ... use fs ...
backend.save_to_file("snapshot.enc")?;  // Persists encrypted
<span class="boring">}</span></code></pre>
<h4 id="selective-file-encryption"><a class="header" href="#selective-file-encryption">Selective File Encryption</a></h4>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Some files encrypted, structure visible
let backend = FileEncryption::new(SqliteBackend::open("data.db")?)
    .with_key(key);
<span class="boring">}</span></code></pre>
<hr>
<h2 id="toctou-proof-tenant-isolation-with-virtual-backends"><a class="header" href="#toctou-proof-tenant-isolation-with-virtual-backends">TOCTOU-Proof Tenant Isolation with Virtual Backends</a></h2>
<h3 id="why-virtual-backends-eliminate-toctou"><a class="header" href="#why-virtual-backends-eliminate-toctou">Why Virtual Backends Eliminate TOCTOU</a></h3>
<p>Traditional path security libraries like <code>strict-path</code> work against a <strong>real filesystem</strong>:</p>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                    REAL FILESYSTEM SECURITY                      │
│                                                                  │
│   Your Process          OS Filesystem         Other Processes   │
│   ┌──────────┐         ┌───────────┐         ┌──────────────┐   │
│   │ Check    │────────▶│ Canonical │◀────────│ Create       │   │
│   │ path     │         │ path      │         │ symlink      │   │
│   └──────────┘         └───────────┘         └──────────────┘   │
│        │                     │                      │           │
│        │    TOCTOU WINDOW    │                      │           │
│        ▼                     ▼                      ▼           │
│   ┌──────────┐         ┌───────────┐         ┌──────────────┐   │
│   │ Use      │────────▶│ DIFFERENT │◀────────│ Modified!    │   │
│   │ path     │         │ path now! │         │              │   │
│   └──────────┘         └───────────┘         └──────────────┘   │
│                                                                  │
│   Problem: OS state can change between check and use             │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<p>Virtual backends eliminate this entirely:</p>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                   VIRTUAL BACKEND SECURITY                       │
│                                                                  │
│   Your Process                                                   │
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                    FileStorage                           │   │
│   │  ┌──────────┐    ┌───────────┐    ┌──────────────────┐  │   │
│   │  │ Resolve  │───▶│ SQLite    │───▶│ Return data      │  │   │
│   │  │ path     │    │ Transaction│   │                  │  │   │
│   │  └──────────┘    └───────────┘    └──────────────────┘  │   │
│   │                        │                                 │   │
│   │              ATOMIC - No external modification possible  │   │
│   └─────────────────────────────────────────────────────────┘   │
│                                                                  │
│   No OS filesystem. No other processes. No TOCTOU.               │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 id="security-comparison-strict-path-vs-virtual-backend"><a class="header" href="#security-comparison-strict-path-vs-virtual-backend">Security Comparison: strict-path vs Virtual Backend</a></h3>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Threat</th><th>strict-path (Real FS)</th><th>Virtual Backend</th></tr>
</thead>
<tbody>
<tr><td>Path traversal</td><td>Prevented (canonicalize + verify)</td><td><strong>Impossible</strong> (no host FS to traverse to)</td></tr>
<tr><td>Symlink race (TOCTOU)</td><td>Mitigated (canonicalize first)</td><td><strong>Impossible</strong> (we control all symlinks)</td></tr>
<tr><td>External symlink creation</td><td>Vulnerable window exists</td><td><strong>Impossible</strong> (single-process ownership)</td></tr>
<tr><td>Windows 8.3 short names</td><td>Partial (only existing files)</td><td><strong>N/A</strong> (no Windows FS)</td></tr>
<tr><td>Namespace escapes (/proc)</td><td>Fixed in soft-canonicalize</td><td><strong>Impossible</strong> (no /proc exists)</td></tr>
<tr><td>Concurrent modification</td><td>OS handles (may race)</td><td><strong>Atomic</strong> (SQLite transactions)</td></tr>
<tr><td>Tenant A accessing Tenant B</td><td>Requires careful path filtering</td><td><strong>Impossible</strong> (separate .db files)</td></tr>
</tbody>
</table>
</div>
<h3 id="encryption-separation-of-concerns"><a class="header" href="#encryption-separation-of-concerns">Encryption: Separation of Concerns</a></h3>
<p><strong>Design principle:</strong> Backends handle storage, middleware handles policy. Container-level encryption is the exception.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Security Level</th><th>Implementation</th><th>Why</th></tr>
</thead>
<tbody>
<tr><td><strong>Locked (container)</strong></td><td><code>SqliteCipherBackend</code></td><td>Must encrypt entire <code>.db</code> file at storage level</td></tr>
<tr><td><strong>Privacy (file contents)</strong></td><td><code>FileEncryption&lt;SqliteBackend&gt;</code> middleware</td><td>Content encryption is policy</td></tr>
<tr><td><strong>Normal</strong></td><td><code>SqliteBackend</code></td><td>User applies encryption as needed</td></tr>
</tbody>
</table>
</div>
<p><strong>Why Locked mode requires a separate backend:</strong></p>
<ul>
<li>SQLCipher encrypts the entire database file transparently</li>
<li>Connection must be opened with password before ANY query</li>
<li>Cannot be added as middleware - it’s a property of the connection itself</li>
<li>Everything is encrypted: file contents, filenames, directory structure, timestamps, inodes</li>
</ul>
<h3 id="sqlitecipherbackend-built-in-feature-sqlite-cipher"><a class="header" href="#sqlitecipherbackend-built-in-feature-sqlite-cipher">SqliteCipherBackend (Built-in, feature: <code>sqlite-cipher</code>)</a></h3>
<p>Full container encryption using <a href="https://www.zetetic.net/sqlcipher/">SQLCipher</a>:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// SQLite backend with full AES-256 encryption via SQLCipher.
/// Requires `sqlite-cipher` feature (uses rusqlite with bundled-sqlcipher).
///
/// Without the password, the .db file is indistinguishable from random bytes.
pub struct SqliteCipherBackend {
    conn: Connection,
}

impl SqliteCipherBackend {
    /// Open with password (derives key via PBKDF2).
    pub fn open(path: impl AsRef&lt;Path&gt;, password: &amp;str) -&gt; Result&lt;Self, FsError&gt; {
        let conn = Connection::open(path.as_ref())?;

        // SQLCipher: Set encryption key derived from password
        conn.pragma_update(None, "key", password)?;

        // Verify we can read (wrong password = SQLITE_NOTADB)
        conn.query_row("SELECT count(*) FROM sqlite_master", [], |_| Ok(()))
            .map_err(|_| FsError::InvalidPassword)?;

        Self::init_schema(&amp;conn)?;
        Ok(Self { conn })
    }

    /// Open with raw 256-bit key (no key derivation).
    pub fn open_with_key(path: impl AsRef&lt;Path&gt;, key: &amp;[u8; 32]) -&gt; Result&lt;Self, FsError&gt; {
        let conn = Connection::open(path.as_ref())?;

        // SQLCipher: Set raw key (hex-encoded with x'' prefix)
        let hex_key = format!("x'{}'", hex::encode(key));
        conn.pragma_update(None, "key", &amp;hex_key)?;

        conn.query_row("SELECT count(*) FROM sqlite_master", [], |_| Ok(()))
            .map_err(|_| FsError::InvalidPassword)?;

        Self::init_schema(&amp;conn)?;
        Ok(Self { conn })
    }

    /// Create new encrypted database with password.
    pub fn create(path: impl AsRef&lt;Path&gt;, password: &amp;str) -&gt; Result&lt;Self, FsError&gt; {
        if path.as_ref().exists() {
            return Err(FsError::AlreadyExists { path: path.as_ref().to_path_buf(), operation: "create" });
        }
        Self::open(path, password)
    }

    /// Change the password on an open database.
    pub fn change_password(&amp;self, new_password: &amp;str) -&gt; Result&lt;(), FsError&gt; {
        self.conn.pragma_update(None, "rekey", new_password)?;
        Ok(())
    }

    fn init_schema(conn: &amp;Connection) -&gt; Result&lt;(), FsError&gt; {
        conn.execute_batch(r#"
            -- Node table: directories, files, symlinks
            CREATE TABLE IF NOT EXISTS nodes (
                inode INTEGER PRIMARY KEY,
                parent_inode INTEGER NOT NULL,
                name TEXT NOT NULL,
                node_type INTEGER NOT NULL,  -- 0=file, 1=dir, 2=symlink
                size INTEGER NOT NULL DEFAULT 0,
                mode INTEGER NOT NULL DEFAULT 0o644,
                nlink INTEGER NOT NULL DEFAULT 1,
                uid INTEGER NOT NULL DEFAULT 0,
                gid INTEGER NOT NULL DEFAULT 0,
                created_at INTEGER,
                modified_at INTEGER,
                accessed_at INTEGER,
                symlink_target TEXT,
                UNIQUE(parent_inode, name),
                FOREIGN KEY (parent_inode) REFERENCES nodes(inode)
            );

            -- Content table: file data (separate for efficient large files)
            CREATE TABLE IF NOT EXISTS content (
                inode INTEGER PRIMARY KEY,
                data BLOB NOT NULL,
                FOREIGN KEY (inode) REFERENCES nodes(inode) ON DELETE CASCADE
            );

            -- Index for directory listing performance
            CREATE INDEX IF NOT EXISTS idx_parent ON nodes(parent_inode);

            -- Root directory (inode 1, parent is self)
            INSERT OR IGNORE INTO nodes (inode, parent_inode, name, node_type, mode)
            VALUES (1, 1, '', 1, 0o755);
        "#)?;
        Ok(())
    }
}

// Implements same traits as SqliteBackend - only difference is encrypted storage
impl Fs for SqliteCipherBackend { /* ... */ }
impl FsFull for SqliteCipherBackend { /* ... */ }
impl FsFuse for SqliteCipherBackend { /* ... */ }
<span class="boring">}</span></code></pre>
<h4 id="what-sqlcipher-encrypts"><a class="header" href="#what-sqlcipher-encrypts">What SQLCipher Encrypts</a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Data</th><th>Encrypted?</th></tr>
</thead>
<tbody>
<tr><td>File contents</td><td>Yes</td></tr>
<tr><td>Filenames</td><td>Yes</td></tr>
<tr><td>Directory structure</td><td>Yes</td></tr>
<tr><td>File sizes</td><td>Yes</td></tr>
<tr><td>Timestamps</td><td>Yes</td></tr>
<tr><td>Permissions</td><td>Yes</td></tr>
<tr><td>Inode mappings</td><td>Yes</td></tr>
<tr><td>SQLite metadata</td><td>Yes</td></tr>
<tr><td><strong>Everything in the .db file</strong></td><td><strong>Yes</strong></td></tr>
</tbody>
</table>
</div>
<h4 id="cargo-configuration"><a class="header" href="#cargo-configuration">Cargo Configuration</a></h4>
<pre><code class="language-toml">[dependencies]
# Regular SQLite (no encryption)
rusqlite = { version = "0.31", features = ["bundled"] }

# SQLCipher (full encryption) - mutually exclusive with above
rusqlite = { version = "0.31", features = ["bundled-sqlcipher"] }
</code></pre>
<p><strong>Feature flags in anyfs:</strong></p>
<pre><code class="language-toml">[features]
default = ["memory"]
sqlite = ["rusqlite/bundled"]
sqlite-cipher = ["rusqlite/bundled-sqlcipher"]  # Replaces sqlite
</code></pre>
<p><strong>Note:</strong> <code>sqlite</code> and <code>sqlite-cipher</code> are mutually exclusive. SQLCipher is a drop-in replacement with the same schema and API.</p>
<h3 id="achieving-security-modes-with-composition"><a class="header" href="#achieving-security-modes-with-composition">Achieving Security Modes with Composition</a></h3>
<p>Users compose backends and middleware to achieve their desired security level:</p>
<h4 id="locked-mode-full-container-encryption"><a class="header" href="#locked-mode-full-container-encryption">Locked Mode (Full Container Encryption)</a></h4>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Everything encrypted - password required to access anything
let backend = SqliteCipherBackend::open("tenant.db", "correct-horse-battery-staple")?;
let fs = FileStorage::new(backend);

// Without password: .db file is random bytes
// With password: full access to everything
<span class="boring">}</span></code></pre>
<h4 id="privacy-mode-contents-encrypted-metadata-visible"><a class="header" href="#privacy-mode-contents-encrypted-metadata-visible">Privacy Mode (Contents Encrypted, Metadata Visible)</a></h4>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// File contents encrypted, metadata (names, sizes, structure) visible
let backend = FileEncryption::new(
    SqliteBackend::open("tenant.db")?
)
.with_key(content_key);

let fs = FileStorage::new(backend);

// Host can: list files, see sizes, run statistics
// Host cannot: read file contents
<span class="boring">}</span></code></pre>
<h4 id="normal-mode-no-encryption"><a class="header" href="#normal-mode-no-encryption">Normal Mode (No Encryption)</a></h4>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// No encryption - user encrypts sensitive files themselves
let backend = SqliteBackend::open("tenant.db")?;
let fs = FileStorage::new(backend);

// User applies per-file encryption as needed
<span class="boring">}</span></code></pre>
<h4 id="mode-comparison"><a class="header" href="#mode-comparison">Mode Comparison</a></h4>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Aspect</th><th>Locked</th><th>Privacy</th><th>Normal</th></tr>
</thead>
<tbody>
<tr><td>Implementation</td><td><code>SqliteCipherBackend</code></td><td><code>FileEncryption&lt;SqliteBackend&gt;</code></td><td><code>SqliteBackend</code></td></tr>
<tr><td>File contents</td><td>Encrypted (SQLCipher)</td><td>Encrypted (AES-GCM)</td><td>Plaintext</td></tr>
<tr><td>Filenames</td><td>Encrypted</td><td>Visible</td><td>Visible</td></tr>
<tr><td>Directory structure</td><td>Encrypted</td><td>Visible</td><td>Visible</td></tr>
<tr><td>File sizes</td><td>Encrypted</td><td>Visible</td><td>Visible</td></tr>
<tr><td>Timestamps</td><td>Encrypted</td><td>Visible</td><td>Visible</td></tr>
<tr><td>Host can analyze</td><td>Nothing</td><td>Metadata only</td><td>Everything</td></tr>
<tr><td>Performance</td><td>Slowest (~10-15% overhead)</td><td>Medium</td><td>Fastest</td></tr>
<tr><td>Feature flag</td><td><code>sqlite-cipher</code></td><td><code>sqlite</code> + middleware</td><td><code>sqlite</code></td></tr>
</tbody>
</table>
</div>
<h4 id="why-this-is-toctou-proof"><a class="header" href="#why-this-is-toctou-proof">Why This Is TOCTOU-Proof</a></h4>
<ol>
<li><strong>No external filesystem</strong> - Paths exist only in our SQLite tables</li>
<li><strong>Atomic transactions</strong> - Path resolution + data access in single transaction</li>
<li><strong>Single-process ownership</strong> - No other process can modify the .db during operation</li>
<li><strong>We control symlinks</strong> - Symlinks are just rows in <code>nodes</code> table, we decide when to follow</li>
<li><strong>No OS involvement</strong> - OS never resolves our virtual paths</li>
</ol>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// This is TOCTOU-proof:
impl SecureSqliteBackend {
    fn resolve_and_read(&amp;self, path: &amp;Path) -&gt; Result&lt;Vec&lt;u8&gt;, FsError&gt; {
        // Single transaction wraps everything
        let tx = self.conn.transaction()?;

        // 1. Resolve path (following symlinks in OUR table)
        let inode = self.resolve_path_internal(&amp;tx, path)?;

        // 2. Read content
        // No TOCTOU - same transaction, same snapshot
        let data = tx.query_row(
            "SELECT data FROM content WHERE inode = ?",
            [inode],
            |row| row.get(0)
        )?;

        // Transaction ensures atomicity
        Ok(data)
    }
}
<span class="boring">}</span></code></pre>
<h4 id="multi-tenant-isolation-1"><a class="header" href="#multi-tenant-isolation-1">Multi-Tenant Isolation</a></h4>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Each tenant gets their own .db file - complete physical isolation
fn create_tenant_storage(tenant_id: &amp;str, encrypted: bool) -&gt; impl Fs {
    let path = format!("tenants/{}.db", tenant_id);

    if encrypted {
        let password = get_tenant_password(tenant_id);
        SqliteCipherBackend::open(&amp;path, &amp;password).unwrap()
    } else {
        SqliteBackend::open(&amp;path).unwrap()
    }
}

// Tenant A literally cannot access Tenant B's data:
// - Different .db files
// - Different passwords (if encrypted)
// - No shared state whatsoever
// - No path filtering bugs possible - there's nothing to filter
<span class="boring">}</span></code></pre>
<p><strong>Comparison with strict-path approach:</strong></p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Approach</th><th>Tenant Isolation</th></tr>
</thead>
<tbody>
<tr><td>Shared filesystem + strict-path</td><td>Logical isolation (paths filtered)</td></tr>
<tr><td>Shared filesystem + PathFilter</td><td>Logical isolation (middleware enforced)</td></tr>
<tr><td><strong>Separate .db file per tenant</strong></td><td><strong>Physical isolation (separate files)</strong></td></tr>
</tbody>
</table>
</div>
<p>Physical isolation is strictly stronger - there’s no bug in path filtering that could leak data because <strong>there’s no shared data to leak</strong>.</p>
<h4 id="host-analysis-with-privacy-mode"><a class="header" href="#host-analysis-with-privacy-mode">Host Analysis with Privacy Mode</a></h4>
<p>When using <code>FileEncryption&lt;SqliteBackend&gt;</code> (Privacy mode), the host can query metadata directly from SQLite:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// Host can analyze metadata without the content encryption key
fn get_tenant_statistics(tenant_db: &amp;str) -&gt; TenantStats {
    // Connect directly to SQLite (no content key needed)
    let conn = Connection::open(tenant_db)?;

    let (file_count, dir_count, total_size) = conn.query_row(
        "SELECT
            COUNT(*) FILTER (WHERE node_type = 0),
            COUNT(*) FILTER (WHERE node_type = 1),
            SUM(size)
         FROM nodes",
        [],
        |row| Ok((row.get(0)?, row.get(1)?, row.get(2)?))
    )?;

    TenantStats { file_count, dir_count, total_size }
}

// List all files (names visible, contents encrypted)
fn list_tenant_files(tenant_db: &amp;str) -&gt; Vec&lt;FileInfo&gt; {
    let conn = Connection::open(tenant_db)?;
    conn.prepare("SELECT name, size, modified_at FROM nodes WHERE node_type = 0")?
        .query_map([], |row| Ok(FileInfo { ... }))?
        .collect()
}
<span class="boring">}</span></code></pre>
<h4 id="replacing-strict-path-usage"><a class="header" href="#replacing-strict-path-usage">Replacing strict-path Usage</a></h4>
<p>For projects currently using strict-path for tenant isolation:</p>
<p><strong>Before (strict-path):</strong></p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use strict_path::VirtualRoot;

fn handle_tenant_request(tenant_id: &amp;str, requested_path: &amp;str) -&gt; Result&lt;Vec&lt;u8&gt;&gt; {
    // Shared filesystem, path containment via strict-path
    let root = VirtualRoot::new(format!("/data/tenants/{}", tenant_id))?;
    let safe_path = root.resolve(requested_path)?;  // TOCTOU window here
    std::fs::read(safe_path)  // Another process could have modified
}
<span class="boring">}</span></code></pre>
<p><strong>After (SqliteCipherBackend):</strong></p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use anyfs::SqliteCipherBackend;

fn handle_tenant_request(tenant_id: &amp;str, requested_path: &amp;str) -&gt; Result&lt;Vec&lt;u8&gt;&gt; {
    // Separate encrypted database per tenant - no path containment needed
    let backend = get_tenant_backend(tenant_id);  // Cached connection
    backend.read(requested_path)  // Atomic, TOCTOU-proof
}
<span class="boring">}</span></code></pre>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Aspect</th><th>strict-path</th><th>Virtual Backend</th></tr>
</thead>
<tbody>
<tr><td>Isolation model</td><td>Logical (path filtering)</td><td>Physical (separate files)</td></tr>
<tr><td>TOCTOU</td><td>Mitigated</td><td><strong>Eliminated</strong></td></tr>
<tr><td>External interference</td><td>Possible</td><td><strong>Impossible</strong></td></tr>
<tr><td>Symlink attacks</td><td>Resolved at check time</td><td><strong>We control all symlinks</strong></td></tr>
<tr><td>Cross-tenant leakage</td><td>Bug in filtering could leak</td><td><strong>No shared data exists</strong></td></tr>
<tr><td>Performance</td><td>Real FS I/O + canonicalization</td><td>SQLite (often faster for small files)</td></tr>
<tr><td>Encryption</td><td>Separate concern</td><td>Built-in (<code>SqliteCipherBackend</code>) or middleware</td></tr>
</tbody>
</table>
</div>
<hr>
<h2 id="known-limitations"><a class="header" href="#known-limitations">Known Limitations</a></h2>
<ol>
<li><strong>No ACLs</strong>: Simple permissions only (Unix mode bits)</li>
<li><strong>Side channels</strong>: Timing attacks, cache attacks require OS/hardware mitigations</li>
<li><strong>SQLite file access</strong>: Host OS can still access the <code>.db</code> file (use Locked mode for encryption)</li>
</ol>
<hr>
<p><em>For implementation details, see <a href="../architecture/adrs.html">Architecture Decision Records</a>.</em></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../comparisons/positioning.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                            </a>

                            <a rel="next prefetch" href="../comparisons/technical-comparison.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../comparisons/positioning.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M41.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.3 256 246.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg></span>
                    </a>

                    <a rel="next prefetch" href="../comparisons/technical-comparison.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z"/></svg></span>
                    </a>
            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>


        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace-2a3cd908.js"></script>
        <script src="../mode-rust-2c9d5c9a.js"></script>
        <script src="../editor-16ca416c.js"></script>
        <script src="../theme-dawn-4493f9c8.js"></script>
        <script src="../theme-tomorrow_night-9dbe62a9.js"></script>

        <script src="../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../mark-09e88c2c.min.js"></script>
        <script src="../searcher-c2a407aa.js"></script>

        <script src="../clipboard-1626706a.min.js"></script>
        <script src="../highlight-abc7f01d.js"></script>
        <script src="../book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
